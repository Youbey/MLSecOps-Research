name: MLSecOps CI Pipeline

on:
  push:
    branches: [ master ]

permissions:
  contents: read
  actions: write

jobs:
  lint_security:
    name: Lint & Security Scans
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install CI deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-ci.txt

      - name: Bandit scan
        id: bandit
        run: |
          bandit -r . -f json -o bandit-report.json || true
          echo "::add-matcher::/usr/local/lib/python3.10/site-packages/bandit/formatters/json.py" || true
      - name: Semgrep scan
        id: semgrep
        run: |
          semgrep --config auto --json --verbosity 1 --output semgrep-report.json || true
      - name: Pip-audit (dependencies)
        id: pip_audit
        run: |
          pip-audit --format json --output pip-audit.json || true
      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            bandit-report.json
            semgrep-report.json
            pip-audit.json
    outputs:
      result: ${{ job.status }}

  unit_tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint_security
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-ci.txt
          pip install -e .

      - name: Run pytest
        id: pytest
        run: |
          pytest -q || true

      - name: Upload pytest logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-logs
          path: |
            ./*.log || true
    outputs:
      result: ${{ job.status }}

  fl_smoke_test:
    name: FL Smoke Test
    runs-on: ubuntu-latest
    needs: unit_tests
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-ci.txt

      - name: Run FL smoke test
        id: fltest
        run: |
          python tests/fl_smoke_test.py || true

      - name: Upload FL smoke artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fl-smoke-artifacts
          path: tests/*
    outputs:
      result: ${{ job.status }}

  discord_notify:
    name: Notify Discord (#git-ci)
    runs-on: ubuntu-latest
    needs: [lint_security, unit_tests]
    if: always()
    steps:
      - name: Build status summary
        id: build_summary
        run: |
          echo "lint=${{ needs.lint_security.result }}" >> $GITHUB_OUTPUT
          echo "unit=${{ needs.unit_tests.result }}" >> $GITHUB_OUTPUT
          # determine overall color (green=3066993 else red=15158332)
          if [ "${{ needs.lint_security.result }}" = "success" ] && \
             [ "${{ needs.unit_tests.result }}" = "success" ]; then
            echo "color=3066993" >> $GITHUB_OUTPUT
            echo "overall=success" >> $GITHUB_OUTPUT
          else
            echo "color=15158332" >> $GITHUB_OUTPUT
            echo "overall=failure" >> $GITHUB_OUTPUT
          fi
      - name: Send Discord embed
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          REPO: ${{ github.repository }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          LINT_RESULT: ${{ needs.lint_security.result }}
          UNIT_RESULT: ${{ needs.unit_tests.result }}
          COLOR: ${{ steps.build_summary.outputs.color }}
          OVERALL: ${{ steps.build_summary.outputs.overall }}
        run: |
          # build embed JSON
          TITLE="MLSecOps CI â€” Pipeline $OVERALL"
          DESCRIPTION="Repo: $REPO\nRun: $RUN_URL"
          read -r -d '' PAYLOAD <<EOF
          {
            "username": "GitHub CI",
            "embeds": [{
              "title": "$TITLE",
              "description": "$DESCRIPTION",
              "fields": [
                {"name":"Lint & Security","value":"$LINT_RESULT","inline":true},
                {"name":"Unit tests","value":"$UNIT_RESULT","inline":true},
              ],
              "color": ${COLOR}
            }]
          }
          EOF
            curl -H "Content-Type: application/json" -d "$PAYLOAD" "$DISCORD_WEBHOOK"
